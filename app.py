import streamlit as st
import time
from openai import OpenAI  # 1. å¯¼å…¥OpenAIåº“ï¼ˆç”¨äºè¿æ¥DeepSeekï¼‰

# --- é¡µé¢é…ç½® ---
st.set_page_config(
    page_title="AI éšç§æ”¿ç­–ç”Ÿæˆå™¨",
    page_icon="ğŸ›¡ï¸",
    layout="centered"
)

# --- ä¾§è¾¹æ  (å·²ç®€åŒ–ï¼Œç§»é™¤ Key è¾“å…¥) ---
with st.sidebar:
    st.image(
        "https://www.apple.com/ac/globalnav/7/zh_CN/images/be15095f-5a20-57d0-ad_icon_apple_image__b5er5ngrzxqq_large.svg",
        width=50)
    st.header("é¡¹ç›®ï¼šå…µå·¥å‚")
    st.markdown("`zhangwei-privacy-engineer-mvp`")
    st.info("""
    **é¡¹ç›®ç›®æ ‡:** å¸®åŠ©ç¡¬ä»¶åˆ›ä¸šè€…å¿«é€Ÿç”Ÿæˆç¬¦åˆGDPRçš„åˆæ­¥éšç§æ”¿ç­–æ–‡æœ¬ã€‚
    """)
    st.divider()
    st.success("API å¯†é’¥å·²é€šè¿‡ st.secrets å®‰å…¨åŠ è½½ã€‚")
    st.warning("è¯·ç¡®ä¿å·²åœ¨æœ¬åœ° .streamlit/secrets.toml æ–‡ä»¶ä¸­é…ç½®äº† Keyã€‚")


# --- ä»»åŠ¡å››ï¼š "å¼€ç«" (å®šä¹‰APIè°ƒç”¨å‡½æ•°) ---
# (æ³¨æ„ï¼šå‡½æ•°ç­¾åå·²æ”¹å›ï¼Œå®ƒéœ€è¦ä¼ å…¥ api_key)
def get_deepseek_response(api_key, prompt_text):
    """
    è°ƒç”¨ DeepSeek API å¹¶è¿”å›ç”Ÿæˆçš„æ–‡æœ¬
    """
    try:
        client = OpenAI(
            api_key=api_key,  # ä½¿ç”¨ä¼ å…¥çš„ Key
            base_url="https://api.deepseek.com"
        )
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt_text}]
        )
        return response.choices[0].message.content
    except Exception as e:
        st.error(f"è°ƒç”¨AIæ—¶å‡ºé”™ï¼š{e}")
        return None


# --- ä¸»ç•Œé¢ ---
st.title("AI éšç§æ”¿ç­–ç”Ÿæˆå™¨")
st.markdown("è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼ŒAI å°†ä¸ºæ‚¨ç”Ÿæˆâ€œæ•°æ®è·¨å¢ƒä¼ è¾“â€æ¡æ¬¾åˆç¨¿ã€‚")

# --- é—®å·è¡¨å• ---
with st.form(key="privacy_questionnaire"):
    # (--- é—®å·æ¨¡å—ä¸€ ---)
    st.header("æ¨¡å—ä¸€ï¼šæ•°æ®æ”¶é›†æ¸…å• (What & Why)")
    q1_pii = st.radio(
        "1. ä½ çš„è®¾å¤‡æ˜¯å¦æ”¶é›†â€œä¸ªäººèº«ä»½ä¿¡æ¯ (PII)â€ï¼Ÿ",
        options=["å¦", "æ˜¯ (ä¾‹å¦‚ï¼šå§“åã€é‚®ç®±ã€æ‰‹æœºå·)"], horizontal=True
    )
    st.subheader("2. ä½ çš„æ™ºèƒ½ç¡¬ä»¶è®¾å¤‡ä¼šæ”¶é›†ä»¥ä¸‹å“ªç±»â€œä¼ æ„Ÿå™¨æ•°æ®â€ï¼Ÿ")
    q2_sensor_labels = [
        "GPSä½ç½® (åŒ…æ‹¬å†å²è½¨è¿¹)", "æ‘„åƒå¤´å½±åƒ (è§†é¢‘æˆ–ç…§ç‰‡)", "éº¦å…‹é£éŸ³é¢‘ (å½•éŸ³æˆ–è¯­éŸ³æŒ‡ä»¤)",
        "å¥åº·ä¸ç”Ÿç‰©ç‰¹å¾ (å¿ƒç‡ã€è¡€æ°§ã€æŒ‡çº¹)", "è¿åŠ¨æ•°æ® (æ­¥æ•°ã€å§¿æ€)", "ç¯å¢ƒæ•°æ® (æ¸©åº¦ã€æ¹¿åº¦)",
        "æˆ‘çš„è®¾å¤‡ä¸æ”¶é›†ä»»ä½•ä¼ æ„Ÿå™¨æ•°æ®"
    ]
    q2_sensor_checks = [st.checkbox(label, key=f"q2_{i}") for i, label in enumerate(q2_sensor_labels)]
    st.subheader("3. ä½ çš„é…å¥—Appæˆ–æœåŠ¡æ˜¯å¦ä¼šæ”¶é›†ç”¨æˆ·çš„â€œè¡Œä¸ºæˆ–ç¤¾äº¤â€æ•°æ®ï¼Ÿ")
    q3_behavioral_labels = ["Appæ“ä½œæ—¥å¿— (ç‚¹å‡»ã€åœç•™æ—¶é•¿)", "æ”¯ä»˜ä¿¡æ¯", "ç¬¬ä¸‰æ–¹è´¦å·ä¿¡æ¯ (å¾®ä¿¡/Googleç™»å½•)",
                            "ç”¨æˆ·çš„è”ç³»äººåˆ—è¡¨ (é€šè®¯å½•)", "å®Œå…¨ä¸æ”¶é›†"]
    q3_behavioral_checks = [st.checkbox(label, key=f"q3_{i}") for i, label in enumerate(q3_behavioral_labels)]
    st.subheader("4. ä½ æ”¶é›†è¿™äº›æ•°æ®çš„ä¸»è¦ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ (æ­¤é¡¹ç”¨äºæœªæ¥åŠŸèƒ½)")
    q4_purpose_labels = ["æ ¸å¿ƒåŠŸèƒ½", "ä½“éªŒä¼˜åŒ–", "ä¸ªæ€§åŒ–æœåŠ¡/å¹¿å‘Š", "ç®—æ³•è®­ç»ƒ", "å®‰å…¨é£æ§"]
    q4_purpose_checks = [st.checkbox(label, key=f"q4_{i}") for i, label in enumerate(q4_purpose_labels)]

    # (--- é—®å·æ¨¡å—äºŒ ---)
    st.header("æ¨¡å—äºŒï¼šæ•°æ®æµè½¬ä¸è·¨å¢ƒ (Where & Who)")
    q5_location = st.radio(
        "5. ä½ çš„ä¸»æœåŠ¡å™¨å­˜å‚¨åœ¨å“ªä¸ªå›½å®¶æˆ–åœ°åŒºï¼Ÿ",
        options=["ä»…åœ¨ä¸­å›½å¤§é™†", "ä»…åœ¨æ¬§ç›Ÿ (EU) å¢ƒå†…", "ä»…åœ¨ç¾å›½ (US) å¢ƒå†…", "å­˜å‚¨åœ¨å…¨çƒå¤šä¸ªåœ°åŒº", "ä¸ç¡®å®š / å…¶ä»–"]
    )
    st.subheader("6. ä½ æ˜¯å¦ä¼šå°†æ•°æ®â€œå…±äº«â€ç»™ç¬¬ä¸‰æ–¹å…¬å¸ï¼Ÿ")
    q6_sharing_labels = ["å¹¿å‘Šæˆ–è¥é”€ä¼™ä¼´", "æ•°æ®åˆ†ææœåŠ¡å•† (å¦‚ è°·æ­Œåˆ†æ)", "äº‘æœåŠ¡å•† (å¦‚ é˜¿é‡Œäº‘, AWS)",
                         "å¦ï¼Œå®Œå…¨ä¸ä¸ä»»ä½•ç¬¬ä¸‰æ–¹å…±äº«"]
    q6_sharing_checks = [st.checkbox(label, key=f"q6_{i}") for i, label in enumerate(q6_sharing_labels)]
    q7_third_party_location = st.radio(
        "7. [å…³é”®] ä½  Q6 ä¸­çš„ç¬¬ä¸‰æ–¹æœåŠ¡å•†æ˜¯å¦åœ¨æ¬§ç›Ÿ(EU)ä»¥å¤–çš„å›½å®¶ï¼Ÿ",
        options=[
            "æ˜¯ï¼Œä»–ä»¬ä¸­è‡³å°‘æœ‰ä¸€ä¸ªåœ¨æ¬§ç›Ÿä»¥å¤– (ä¾‹å¦‚ Google, AWS, OpenAI, é˜¿é‡Œäº‘ç­‰)",
            "å¦ï¼Œæˆ‘ç¡®è®¤æˆ‘æ‰€æœ‰çš„æœåŠ¡å•†éƒ½åœ¨æ¬§ç›Ÿå¢ƒå†…",
            "æˆ‘ä¸ç¡®å®š (æ³•å¾‹ä¸Šè§†åŒ'æ˜¯')"
        ]
    )

    # (--- é—®å·æ¨¡å—ä¸‰ ---)
    st.header("æ¨¡å—ä¸‰ï¼šåˆè§„ä¸å®‰å…¨ (How) (æ­¤é¡¹ç”¨äºæœªæ¥åŠŸèƒ½)")
    q8_children = st.radio("8. ä½ çš„äº§å“æ˜¯å¦ä¸»è¦é¢å‘â€œå„¿ç«¥â€ï¼Ÿ", options=["å¦", "æ˜¯"], horizontal=True)
    q9_access = st.radio("9. ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®ã€ä¿®æ”¹æˆ–åˆ é™¤ä»–ä»¬çš„æ•°æ®ï¼Ÿ", options=["æ˜¯ï¼Œå¯è‡ªåŠ©", "æ˜¯ï¼Œéœ€è”ç³»å®¢æœ", "å¦"])
    q10_breach = st.radio("10. ä½ æ˜¯å¦æœ‰æ•°æ®æ³„éœ²åº”æ€¥æµç¨‹ï¼Ÿ", options=["å¦", "æ˜¯"], horizontal=True)
    q11_contact = st.radio("11. ç”¨æˆ·é€šè¿‡ä»€ä¹ˆæ–¹å¼è”ç³»ä½ ï¼Ÿ", options=["ç”µå­é‚®ç®±", "åœ¨çº¿å®¢æœ", "ç”µè¯", "å°šæœªç¡®å®š"])

    # (--- æäº¤æŒ‰é’® ---)
    st.divider()
    submitted = st.form_submit_button(
        "ç”Ÿæˆâ€œæ•°æ®è·¨å¢ƒä¼ è¾“â€æ¡æ¬¾",
        type="primary",
        use_container_width=True
    )

# --- æŒ‰é’®ç‚¹å‡»åçš„é€»è¾‘ (ä»»åŠ¡ 2, 3, 4) ---
if submitted:

    # ä»»åŠ¡äºŒï¼šæ”¶é›†æ‰€æœ‰Streamlitç»„ä»¶çš„è¾“å…¥
    with st.spinner("æ­£åœ¨æ”¶é›†æ‚¨çš„å›ç­”..."):
        time.sleep(0.5)

        # 1. æ£€æŸ¥å¹¶ä» st.secrets å®‰å…¨è¯»å– API Key
        try:
            # âœ… è¿™æ˜¯æœ€å…³é”®çš„ä¸€è¡Œä»£ç 
            api_key = st.secrets["DEEPSEEK_API_KEY"]
            if not api_key or api_key == "sk-xxxxxxxxxxxxxxxxxxxxxxxx":
                st.error("API Key é…ç½®ä¸æ­£ç¡®ã€‚è¯·æ£€æŸ¥ä½ çš„ .streamlit/secrets.toml æ–‡ä»¶ã€‚")
                st.stop()
        except KeyError:
            st.error("æœªæ‰¾åˆ° API Keyï¼è¯·ç¡®ä¿ä½ å·²åˆ›å»º .streamlit/secrets.toml æ–‡ä»¶ã€‚")
            st.stop()  # åœæ­¢æ‰§è¡Œ

        # 2. æ”¶é›† Checkbox çš„ç»“æœå¹¶è½¬ä¸ºå­—ç¬¦ä¸²
        q2_selected = [q2_sensor_labels[i] for i, checked in enumerate(q2_sensor_checks) if checked]
        q2_sensors_str = ", ".join(q2_selected) if q2_selected else "æ— "

        q3_selected = [q3_behavioral_labels[i] for i, checked in enumerate(q3_behavioral_checks) if checked]
        q3_behavioral_str = ", ".join(q3_selected) if q3_selected else "æ— "

        q6_selected = [q6_sharing_labels[i] for i, checked in enumerate(q6_sharing_checks) if checked]
        q6_sharing_str = ", ".join(q6_selected) if q6_selected else "æ— "

        # 3. æ”¶é›† Radio çš„ç»“æœ (q1_pii, q5_location, q7_third_party_location å·²å‡†å¤‡å¥½)

    # ä»»åŠ¡ä¸‰ï¼šæ„å»ºâ€œå‚æ•°åŒ–â€çš„åŠ¨æ€Prompt
    with st.spinner("æ­£åœ¨å‚æ•°åŒ–â€œæ³•å¾‹å¼¹è¯â€..."):
        time.sleep(0.5)

        final_prompt = f"""
# è§’è‰²: 
ä½ æ˜¯ä¸€åç²¾é€šGDPRçš„ä¸“ä¸šéšç§é¡¾é—®ï¼Œç‰¹åˆ«æ“…é•¿ä¸ºæ™ºèƒ½ç¡¬ä»¶(IoT)åˆ›ä¸šå…¬å¸èµ·è‰æ¸…æ™°ã€åˆè§„çš„éšç§æ”¿ç­–ã€‚

# ä»»åŠ¡:
åŸºäºç”¨æˆ·æä¾›çš„æœåŠ¡å™¨ä½ç½®å’Œç¬¬ä¸‰æ–¹å…±äº«æƒ…å†µï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦è¢«ä¼ è¾“è‡³æ¬§ç›Ÿç»æµåŒº(EEA)ä¹‹å¤–ã€‚å¦‚æœæ˜¯ï¼Œè¯·ç”Ÿæˆä¸€æ®µéšç§æ”¿ç­–æ¡æ¬¾ï¼Œæ¸…æ™°åœ°å‘ç”¨æˆ·è§£é‡Šå…¶æ•°æ®è·¨å¢ƒä¼ è¾“çš„å…¨éƒ¨åˆKè§„æ€§åŸºç¡€ã€‚

# äº‹å®èƒŒæ™¯ (ç”±ç”¨æˆ·é—®å·æä¾›):
1.  è®¾å¤‡æ”¶é›†çš„PII: {q1_pii}
2.  è®¾å¤‡æ”¶é›†çš„ä¼ æ„Ÿå™¨æ•°æ®: {q2_sensors_str}
3.  è®¾å¤‡æ”¶é›†çš„è¡Œä¸ºæ•°æ®: {q3_behavioral_str}
4.  æ•°æ®å­˜å‚¨çš„æœåŠ¡å™¨ä½ç½®: {q5_location}
5.  ç¬¬ä¸‰æ–¹æœåŠ¡å•†ä½ç½®: {q7_third_party_location}
6.  å…±äº«çš„ç¬¬ä¸‰æ–¹ç±»å‹: {q6_sharing_str}

# ç”ŸæˆæŒ‡ç¤º:
1.  **åˆ¤æ–­é€»è¾‘**: 
    ä»”ç»†åˆ†æ [æ•°æ®å­˜å‚¨çš„æœåŠ¡å™¨ä½ç½®] å’Œ [ç¬¬ä¸‰æ–¹æœåŠ¡å•†ä½ç½®]ã€‚

2.  **æ’°å†™æ¡æ¬¾ (è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹é€»è¾‘)**:

    * **æƒ…å†µAï¼š(æ•°æ®å®Œå…¨ä¸å‡ºå¢ƒ)**
        * **è§¦å‘æ¡ä»¶**: 
            * [æ•°æ®å­˜å‚¨çš„æœåŠ¡å™¨ä½ç½®] æ˜¯ "ä»…åœ¨æ¬§ç›Ÿ (EU) å¢ƒå†…" 
            * **å¹¶ä¸”** [ç¬¬ä¸‰æ–¹æœåŠ¡å•†ä½ç½®] æ˜¯ "å¦ï¼Œæˆ‘ç¡®è®¤æˆ‘æ‰€æœ‰çš„æœåŠ¡å•†éƒ½åœ¨æ¬§ç›Ÿå¢ƒå†…"
        * **ç”Ÿæˆå†…å®¹**:
            è¯·ç”Ÿæˆä¸€æ®µæ¡æ¬¾ï¼Œå‘ç”¨æˆ·ä¿è¯ï¼šä»–ä»¬çš„æ•°æ®å°†ä¸¥æ ¼åœ¨æ¬§ç›Ÿå¢ƒå†…å­˜å‚¨å’Œå¤„ç†ï¼Œå¹¶å—åˆ°GDPRçš„å…¨é¢ä¿æŠ¤ã€‚

    * **æƒ…å†µBï¼š(ä¸»æœåŠ¡å™¨åœ¨å¢ƒå¤–)**
        * **è§¦å‘æ¡ä»¶**: 
            * [æ•°æ®å­˜å‚¨çš„æœåŠ¡å™¨ä½ç½®] æ˜¯ "ä»…åœ¨ä¸­å›½å¤§é™†", "ä»…åœ¨ç¾å›½ (US) å¢ƒå†…", "å­˜å‚¨åœ¨å…¨çƒå¤šä¸ªåœ°åŒº", æˆ– "ä¸ç¡®å®š / å…¶ä»–" 
        * **ç”Ÿæˆå†…å®¹**:
            è¯·å¿…é¡»ç”Ÿæˆä¸€æ®µæ¡æ¬¾ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå…³é”®ç‚¹ï¼š
            a. **(é€æ˜åº¦)** æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ï¼Œä¸ºäº†æä¾›æœåŠ¡ï¼Œä»–ä»¬çš„ä¸ªäººæ•°æ®ï¼ˆåŒ…æ‹¬ {q1_pii}ã€{q2_sensors_str}ã€{q3_behavioral_str}ï¼‰å°†è¢«ä¼ è¾“å¹¶å­˜å‚¨åœ¨ä½äº [{q5_location}] çš„æœåŠ¡å™¨ä¸Šã€‚
            b. **(ä¸»è¦åˆè§„åŸºç¡€ - Art. 46)** è§£é‡Šè¯´æ˜ï¼Œç”±äºè¯¥åœ°åŒºæœªè·å¾—æ¬§ç›Ÿå§”å‘˜ä¼šçš„â€œå……åˆ†æ€§è®¤å®šâ€ï¼Œæˆ‘ä»¬å°†ä¸»è¦ä¾èµ–æ¬§ç›Ÿå§”å‘˜ä¼šæ‰¹å‡†çš„â€œæ ‡å‡†åˆåŒæ¡æ¬¾ (Standard Contractual Clauses, SCCs)â€ ä½œä¸ºæ•°æ®ä¼ è¾“çš„é€‚å½“ä¿éšœæªæ–½ã€‚
            c. **(æ¬¡è¦åˆè§„åŸºç¡€ - Art. 49)** è¡¥å……è¯´æ˜ï¼Œå¯¹äºæŸäº›ç‰¹å®šçš„ã€éå¿…è¦çš„ä¼ è¾“ï¼ˆä¾‹å¦‚å…±äº«ç»™ [{q6_sharing_str}]ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯èƒ½åœ¨å¾å¾—æ‚¨åŒæ„çš„æƒ…å†µä¸‹ï¼Œä¾èµ–æ‚¨çš„â€œæ˜ç¡®åŒæ„â€ (Explicit Consent) ä½œä¸ºæ³•å¾‹åŸºç¡€ã€‚
            d. **(ç”¨æˆ·ä¿éšœ)** å‘ç”¨æˆ·æ‰¿è¯ºï¼Œæ— è®ºæ•°æ®åœ¨ä½•å¤„ï¼Œå…¬å¸éƒ½å°†é‡‡å–ä¸€åˆ‡åˆç†çš„æŠ€æœ¯å’Œç»„ç»‡æªæ–½ï¼ˆå¦‚æ•°æ®åŠ å¯†ï¼‰æ¥ç¡®ä¿å…¶å®‰å…¨ã€‚

    * **æƒ…å†µCï¼š(ä¸»æœåŠ¡å™¨åœ¨å¢ƒå†…ï¼Œä½†ç¬¬ä¸‰æ–¹åœ¨å¢ƒå¤–)**
        * **è§¦å‘æ¡ä»¶**: 
            * [æ•°æ®å­˜å‚¨çš„æœåŠ¡å™¨ä½ç½®] æ˜¯ "ä»…åœ¨æ¬§ç›Ÿ (EU) å¢ƒå†…" 
            * **å¹¶ä¸”** [ç¬¬ä¸‰æ–¹æœåŠ¡å•†ä½ç½®] æ˜¯ "æ˜¯ï¼Œä»–ä»¬ä¸­è‡³å°‘æœ‰ä¸€ä¸ªåœ¨æ¬§ç›Ÿä»¥å¤–..." æˆ– "æˆ‘ä¸ç¡®å®š (æ³•å¾‹ä¸Šè§†åŒ'æ˜¯')"
        * **ç”Ÿæˆå†…å®¹**:
            è¯·ç”Ÿæˆä¸€æ®µæ¡æ¬¾ï¼Œè¯´æ˜ï¼š
            a. **(é€æ˜åº¦)** "æˆ‘ä»¬ä¸»è¦å°†æ‚¨çš„æ•°æ®å­˜å‚¨åœ¨æ¬§ç›Ÿå¢ƒå†…ã€‚ä½†æ˜¯ï¼Œä¸ºäº†å®ç°ç‰¹å®šåŠŸèƒ½ï¼ˆä¾‹å¦‚ {q6_sharing_str}ï¼‰ï¼Œæ‚¨çš„éƒ¨åˆ†æ•°æ®ï¼ˆåŒ…æ‹¬ {q1_pii}ã€{q2_sensors_str}ã€{q3_behavioral_str}ï¼‰å¯èƒ½ä¼šè¢«ä¼ è¾“ç»™ä½äºEEAå¢ƒå¤–çš„ç¬¬ä¸‰æ–¹åˆä½œä¼™ä¼´ã€‚"
            b. **(åˆè§„åŸºç¡€)** "å¯¹äºæ­¤ç±»ä¼ è¾“ï¼Œæˆ‘ä»¬å°†åŒæ ·ä¾èµ– â€œæ ‡å‡†åˆåŒæ¡æ¬¾ (SCCs)â€ æˆ–åœ¨å¾å¾—æ‚¨ â€œæ˜ç¡®åŒæ„â€ (Explicit Consent) çš„å‰æä¸‹è¿›è¡Œï¼Œä»¥ç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨ã€‚"
"""

    with st.expander("âœ… [è°ƒè¯•ä¿¡æ¯] æŸ¥çœ‹å‘é€ç»™AIçš„æœ€ç»ˆPrompt"):
        st.text(final_prompt)

    # ä»»åŠ¡å››ï¼š "å¼€ç«" (è°ƒç”¨APIå¹¶æ˜¾ç¤ºç»“æœ)
    with st.spinner("AIâ€œå¤§è„‘â€æ­£åœ¨æ€è€ƒ...è¯·ç¨å€™..."):
        # (æ³¨æ„ï¼šç°åœ¨æˆ‘ä»¬æŠŠå®‰å…¨çš„ api_key ä¼ ç»™å‡½æ•°)
        response_text = get_deepseek_response(api_key, final_prompt)

    if response_text:
        st.success("AI ç”ŸæˆæˆåŠŸï¼")
        st.divider()
        st.subheader("ğŸ¤– AI ç”Ÿæˆçš„â€œæ•°æ®è·¨å¢ƒä¼ è¾“â€æ¡æ¬¾ï¼š")
        st.markdown(response_text)